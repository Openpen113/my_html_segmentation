<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>音檔對話分段播放器（手機版/純前端）</title>
<style>
  :root{
    --bg:#f3f4f6;--card:#fff;--text:#0f172a;--muted:#6b7280;
    --primary:#2563eb;--primary-2:#1d4ed8;--played:#10b981;--played-2:#059669;
    --border:#e5e7eb;--shadow:0 10px 24px rgba(0,0,0,.06)
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif}
  .safe-pt{padding-top:env(safe-area-inset-top)}
  .safe-pb{padding-bottom:env(safe-area-inset-bottom)}
  .wrap{max-width:520px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:10;background:#fffcc;backdrop-filter:saturate(1.2) blur(6px)}
  .head{background:#fff;border-bottom:1px solid var(--border);padding:12px 16px}
  .h1{margin:0 0 4px;font-weight:800;font-size:22px}
  .hint{margin:0;color:var(--muted);font-size:12px}
  .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px}
  label{display:block;margin:8px 0 6px;font-weight:600;font-size:14px;color:#111827}
  input[type=file]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff}
  .status{min-height:24px;margin:10px 0 14px;color:var(--muted);font-size:14px;text-align:center}
  .status.ok{color:#16a34a}.status.err{color:#dc2626}.status.info{color:#2563eb}
  .section-title{font-weight:700;margin:8px 0 8px}
  .segments{display:grid;gap:10px}
  .segbtn{width:100%;padding:14px 16px;border:0;border-radius:14px;background:var(--primary);color:#fff;font-weight:800;letter-spacing:.3px;box-shadow:var(--shadow);font-size:16px}
  .segbtn:active{transform:scale(.98)}
  .segbtn:hover{background:var(--primary-2)}
  .segbtn.played{background:var(--played)} .segbtn.played:hover{background:var(--played-2)}
  .panel{margin:18px 0 80px}
  details{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:12px 12px}
  summary{list-style:none;cursor:pointer}
  summary::-webkit-details-marker{display:none}
  .sumrow{display:flex;align-items:center;justify-content:space-between}
  .sumrow .tag{color:var(--muted);font-size:12px}
  .row{margin:12px 0}
  .range{width:100%}
  .range input[type=range]{width:100%}
  .num{font:600 20px/1.2 ui-monospace,Menlo,Consolas,monospace}
  .ctlrow{display:flex;align-items:center;justify-content:center;gap:16px}
  .ctlbtn{width:56px;height:56px;border-radius:50%;border:0;background:#e5e7eb;font-weight:900;font-size:26px;box-shadow:var(--shadow)}
  .ctlbtn:active{transform:scale(.97);filter:brightness(.95)}
  .btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:14px;border-radius:14px;border:0;box-shadow:var(--shadow);font-weight:800}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.primary:hover{background:var(--primary-2)}
  .btn.gray{background:#e5e7eb;color:#111827}
  .mt6{margin-top:16px}
</style>
</head>
<body>
<header class="safe-pt">
  <div class="head">
    <h1 class="h1">音檔對話分段播放器</h1>
    <p id="hint" class="hint">步驟：選檔 → 分析 → 逐段播放（純前端處理，不上傳）。</p>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <label for="file">上傳音訊檔案（.mp3 / .wav / .m4a ...）</label>
    <input id="file" type="file">
    <div id="status" class="status">請選擇一個音訊檔案，然後開始分段。</div>

    <h2 class="section-title">分段結果</h2>
    <div id="segments" class="segments"></div>

    <div class="panel">
      <details>
        <summary>
          <div class="sumrow">
            <strong>進階設定</strong>
            <span class="tag">（點此展開/收起）</span>
          </div>
        </summary>
        <div class="row">
          <label>靜音音量閾值：<span id="vThr" class="num">0.05</span></label>
          <input id="thr" type="range" min="0.01" max="0.5" step="0.01" value="0.05" class="range">
        </div>
        <div class="row">
          <label>最短靜音間隔（毫秒）</label>
          <div class="ctlrow">
            <button id="minus" class="ctlbtn">–</button>
            <span id="vSil" class="num" style="min-width:72px;text-align:center">120</span>
            <button id="plus"  class="ctlbtn">+</button>
          </div>
        </div>
        <div class="row">
          <label>最短對話長度（毫秒）：<span id="vSeg" class="num">500</span></label>
          <input id="seg" type="range" min="200" max="5000" step="100" value="500" class="range">
        </div>
        <div class="row">
          <button id="reanalyze" class="btn primary">重新分析（並清除綠色標記）</button>
          <button id="clear" class="btn gray mt6">清除本機記錄</button>
        </div>
      </details>
    </div>
  </div>
</main>

<div class="safe-pb"></div>

<script>
/* ===== 基本元素 ===== */
const fileEl = document.getElementById('file');
const statusEl = document.getElementById('status');
const segmentsEl = document.getElementById('segments');
const thrEl = document.getElementById('thr'), vThr = document.getElementById('vThr');
const segEl = document.getElementById('seg'), vSeg = document.getElementById('vSeg');
const vSil = document.getElementById('vSil'), minus = document.getElementById('minus'), plus = document.getElementById('plus');
const reBtn = document.getElementById('reanalyze'), clrBtn = document.getElementById('clear');
const hintEl = document.getElementById('hint');

function setStatus(t, cls){ statusEl.textContent=t; statusEl.className='status '+(cls||''); }
function fmt(s){ return new Date(s*1000).toISOString().substr(11,8); }
vThr.textContent = thrEl.value; vSeg.textContent = segEl.value;

/* ===== AudioContext（iOS 要使用者互動） ===== */
const AC = window.AudioContext || window.webkitAudioContext;
let ctx = null; function ensureCtx(){ if(!ctx) ctx = new AC(); if(ctx.state==='suspended') ctx.resume(); }
document.addEventListener('touchstart', ensureCtx, { once:true });
document.addEventListener('click', ensureCtx, { once:true });

/* ===== 狀態 ===== */
let buf = null, node = null;
let played = new Set();
let storageKey = '';
let lastMeta = null;

/* ===== 上次檔名提示 ===== */
(function(){
  const lastName = localStorage.getItem('segmenter:lastName');
  if (lastName) hintEl.textContent = `上次使用檔案：${lastName}。請再次選同一檔，我會自動恢復設定與已播放標記。`;
})();

/* ===== localStorage ===== */
function saveState(){
  if(!storageKey) return;
  const st = { params:{ thr:+thrEl.value, sil:+vSil.textContent, seg:+segEl.value }, played:[...played] };
  localStorage.setItem(storageKey, JSON.stringify(st));
  localStorage.setItem('segmenter:lastKey', storageKey);
  localStorage.setItem('segmenter:lastName', lastMeta?.name || '');
}
function loadState(key){
  try{ return JSON.parse(localStorage.getItem(key)||'null'); }catch{return null}
}

/* ===== SHA-256 用來辨識同一檔 ===== */
async function sha256(ab){ const h = await crypto.subtle.digest('SHA-256', ab); return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,'0')).join(''); }
function makeKey(n,sz,sha){ return `segmenter:${n}:${sz}:${sha}`; }

/* ===== 參數事件 ===== */
thrEl.addEventListener('input', ()=>{ vThr.textContent = thrEl.value; });
segEl.addEventListener('input', ()=>{ vSeg.textContent = segEl.value; });
minus.addEventListener('click', ()=>{ const v=+vSil.textContent; vSil.textContent = Math.max(100, v-20); saveState(); });
plus .addEventListener('click', ()=>{ const v=+vSil.textContent; vSil.textContent = Math.min(3000, v+20); saveState(); });
[thrEl,segEl].forEach(el=>el.addEventListener('change', saveState));

/* ===== 檔案載入 ===== */
fileEl.addEventListener('change', async e=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  ensureCtx();
  setStatus('正在載入並計算雜湊…');
  const ab = await f.arrayBuffer();
  const hash = await sha256(ab);
  storageKey = makeKey(f.name, f.size, hash);
  lastMeta = { name:f.name, size:f.size, hash };
  played.clear();

  const saved = loadState(storageKey);
  if(saved && saved.params){
    thrEl.value = saved.params.thr ?? 0.05; vThr.textContent = thrEl.value;
    vSil.textContent = saved.params.sil ?? 120;
    segEl.value = saved.params.seg ?? 500; vSeg.textContent = segEl.value;
    (saved.played||[]).forEach(i=>played.add(i));
    setStatus(`已恢復上次設定與已播放記錄（${f.name}）。`,'info');
  }else{
    setStatus('首次載入此檔案。');
  }

  setStatus('正在解碼音檔…');
  buf = await ctx.decodeAudioData(ab.slice(0));
  analyzeAndRender();
  saveState();
});

/* ===== 重新分析（清空綠色） ===== */
reBtn.addEventListener('click', ()=>{
  if(!buf) return setStatus('請先上傳音檔。','err');
  played.clear();
  analyzeAndRender();
  saveState();
});

/* ===== 清除本機記錄 ===== */
clrBtn.addEventListener('click', ()=>{
  if(storageKey) localStorage.removeItem(storageKey);
  played.clear();
  [...segmentsEl.querySelectorAll('button')].forEach(b=>b.classList.remove('played'));
  setStatus('已清除本機記錄。');
});

/* ===== 分段與渲染 ===== */
function analyzeAndRender(){
  setStatus('正在分析音檔…');
  const segs = segment(buf,{
    thr: +thrEl.value,
    sil: +vSil.textContent,
    seg: +segEl.value
  });
  if(!segs.length){ segmentsEl.innerHTML=''; setStatus('未偵測到任何段落，請調整參數後重試。','err'); return; }
  setStatus(`分析完成！共偵測到 ${segs.length} 個對話段落。`,'ok');
  render(segs);
}
function segment(b,opt){
  const ch=b.getChannelData(0), sr=b.sampleRate;
  const thr=opt.thr, minSil=Math.floor(opt.sil/1000*sr), minSeg=Math.floor(opt.seg/1000*sr);
  let out=[], lastEnd=0, silStart=-1;
  const W=8; let acc=0, win=new Array(W).fill(0), wi=0;
  for(let i=0;i<ch.length;i++){
    const a=Math.abs(ch[i]); acc-=win[wi]; acc+=a; win[wi]=a; wi=(wi+1)%W;
    const vol=acc/W, isSil=vol<thr;
    if(isSil){ if(silStart===-1) silStart=i; }
    else if(silStart!==-1){
      const d=i-silStart;
      if(d>=minSil){
        const s=lastEnd,e=silStart,len=e-s;
        if(len>=minSeg) out.push({start:s/sr,end:e/sr});
        lastEnd=i;
      }
      silStart=-1;
    }
  }
  if(ch.length-lastEnd>=minSeg) out.push({start:lastEnd/sr,end:ch.length/sr});
  return out;
}
function render(segs){
  segmentsEl.innerHTML='';
  segs.forEach((s,i)=>{
    const btn=document.createElement('button');
    btn.className='segbtn'; btn.textContent=`播放對話 #${i+1}（${fmt(s.start)} - ${fmt(s.end)}）`;
    if(played.has(i)) btn.classList.add('played');
    btn.addEventListener('click', ()=>{
      play(s.start,s.end);
      btn.classList.add('played'); played.add(i); saveState();
    });
    segmentsEl.appendChild(btn);
  });
}
function play(start,end){
  if(!buf) return; ensureCtx();
  if(node){ try{node.stop();}catch{} }
  const dur=end-start; if(dur<=0) return;
  const nb=ctx.createBuffer(buf.numberOfChannels, Math.floor(dur*ctx.sampleRate), ctx.sampleRate);
  for(let ch=0; ch<buf.numberOfChannels; ch++){
    const src=buf.getChannelData(ch), dst=nb.getChannelData(ch);
    const off=Math.floor(start*ctx.sampleRate), len=Math.min(dst.length, src.length-off);
    dst.set(src.subarray(off,off+len));
  }
  node=ctx.createBufferSource(); node.buffer=nb; node.connect(ctx.destination); node.start(0);
  node.onended=()=>{ node=null; };
}
</script>
</body>
</html>
